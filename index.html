<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>


        .bold {
            /*font-weight: bold;*/
        }

    </style>
    <script src="http://cdn.bootcss.com/vue/1.0.17/vue.js"></script>
    <script src="http://cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>

    <script src="data.js"></script>
    <script src="parts.js"></script>

    <link href="assert/materialize/css/materialize.min.css" rel="stylesheet">
    <link href="assert/main.css" rel="stylesheet">

    <script src="assert/materialize/js/materialize.min.js"></script>
    <script src="help.js"></script>
</head>
<body>
<!-- item template -->
<script type="text/x-template" id="item-template">
    <li>
        <div :class="{bold: isFolder}">
            <!--有子项,显示+--><span @click="toggleOpen" v-if="isFolder">{{open ? '-' : '+'}}</span>
            <!-- 无子项，补白--><span @click="toggleOpen" v-else>&nbsp;&nbsp;</span>

            <!--field--><input type="text" v-model="model.field" class="data-field" placeholder="field">

            <!--value--><span v-if="!model.child  && !model.extend">: <input type="text" v-model="model.value" class="data-value" placeholder="value"></span>

            <span @click="delChild" v-if="!model.undelete">X</span>
            <!--有括展项-->
            <div v-if="chooseChildShow" class="choose-child-clear" @click="hideChildShow"></div>
            <span v-if="model.extend" class="choose-child">
                <a  href='#' @click="showchooseChild" >+</a>


                <!-- 下拉扩展项 -->
                <ul v-show="chooseChildShow" class="choose-child-box">
                    <li v-for="item in subparts[model.extend]"
                        v-show="!item.only"
                        v-if="!item.disabled"
                        @click="extendChild(item)">
                        <a href="#!">{{item.field}}</a>
                    </li>

                </ul>
            </span>

        </div>
        <ul v-show="open" v-if="isFolder">
            <item
                    class="data-item"
                    v-for="model in model.child"
                    :model="model"
                    :parts="parts"
                    >
            </item>

            <!--<li @click="addChild" v-show="false">+</li>-->
        </ul>
    </li>
</script>

<! -- nav -->
<nav>
    <div class="nav-wrapper">
        <div class="col s12">
            <a href="#!" class="brand-logo">&nbsp;&nbsp;ES Query</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="#">Document</a></li>
                <li><a href="https://github.com/whybangbang/es_query_dsl_mindmanger">Github</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- app -->
<div id="app">

    <div class="row">
        <div class="col s2 input-select">
            <input type="text" v-model="treeProject">
            <select v-model="treeProject">
                <option v-for="item in treeProjectLists" track-by="$index">{{item}}</option>
            </select>

        </div>
        <div class="col s6 input-select">
            <input type="text" v-model="treeName">
            <select v-model="treeName">
                <option v-for="item in treeNameLists" track-by="$index">{{item}}</option>
            </select>
        </div>
        <div class="col s4">
            <a  @click="openTree" class="waves-effect waves-light btn">open</a>
            <a @click="saveTree"  class="waves-effect waves-light btn">save</a>
        </div>
    </div>
    <div class="row">
        <div class="col s6">
            <ul>
                <item
                        class="item"
                        :model="treeData"
                        :parts="parts">
                </item>
            </ul>
        </div>
        <div class="col s6">
            <p>Write DSL/Elasticsearch quickly! 让ES查询语句不发指！</p>
            <textarea class="getstr">{{{getStr}}}</textarea>
        </div>
    </div>
</div>

<!-- footer -->
<footer class="page-footer">
    <div class="container">
        <div class="row">
            <div class="col l6 s12">
                <h5 class="white-text">Footer Content</h5>
                <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
            </div>
            <div class="col l4 offset-l2 s12">
                <h5 class="white-text">Links</h5>
                <ul>
                    <li><a class="grey-text text-lighten-3" href="http://es.xiaoleilu.com/">Elasticsearch 权威指南</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            © 2016 Copyright Text
            <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
        </div>
    </div>
</footer>


<script>

    /*
     编写示例：
     field str 字键名
     value 值，根据用户填的可自动生成，也可提供默认值
     extend 可扩展，默认为false不可扩展，为ture为随意扩展，为filter时为term、range、exist、bool、and扩展
     open 展开，默认为false，为true时默认为展开的
     root 是否为根元素，根元素不可删除
     choose 是否自动显示菜单 true为显示，false默认值
     undelete 无法删除，默认为false可删除，为true可删除
     group 组，用数字表明，同1组的在一个层下只能出现1次
     and、or、bool按array处理
     disabled: 不显示该字段，默认为false显示，true为不显示

     概念辨析：
     extend：增加子项
     add：增同级项目
     open： 展开显示
     only: 此值为唯一
     tree: 原始数据
     parts: 辅助供选择的； subparts 各子临时缓存的
     dsl：最终生成的语句
     */
    //filter 可组合部分

    // 整体框架

    Vue.config.debug = true
    // define the item component
    Vue.component('item', {
        template: '#item-template',
        props: ['model','parts'],
        data: function () {
            return {
                open: this.model.open ? this.model.open : false,
                chooseChildShow:!!this.model.choose,
                subparts:clone(parts)
            }
        },
        created:function(){
            //清除父展开的选项
            if(this.$parent.hasOwnProperty('chooseChildShow')){
                this.$parent.chooseChildShow=false;
            }
            /*
            console.log(this.model.field)
            //清除唯一
            if(this.group){
                for(var son in this.$parent.$children){
                    if($parent.$children[i].parts
                    }
                }
            for(var i in parts[extend]){
                if(parts[extend][i].group===field.group){
                    Vue.set(this.subparts[extend][i],'only',true)


                }
            }*/
        },
        computed: {
            isFolder: function () {
                return this.model.child &&
                        this.model.child.length
            }
        },
        methods: {
            toggleOpen: function () {
                if (this.isFolder) {
                    this.open = !this.open;
                }
            },
            showchooseChild:function(){
                //查询子数据

                //先进行only处理
                //遍历子部件
                if(!checkArray(this.model.field)){//排除and、or
                    for(var son in this.$children){
                        if(this.$children[son].model.group){//判断是否分组
                            var group_num=this.$children[son].model.group;//得到分组号
                            //修改数据subparts
                            for(var i in parts[this.model.extend]){
                                if(parts[this.model.extend][i].group===group_num){
                                    Vue.set(this.subparts[this.model.extend][i],'only',true)
                                }
                            }
                        }
                    }
                }
              //显示选项栏
              this.chooseChildShow=true;
            },
            hideChildShow:function(){
                this.chooseChildShow=false;
                //隐藏选项，这里vm.create冗余,单质量写并不好
                function hide(obj){
                    for(var i in obj.$children){
                        if(obj.hasOwnProperty('chooseChildShow')){
                            obj['chooseChildShow']=false
                        }
                            hide(obj.$children[i])
                    }
                }
                hide(vm)
            },
            extendChild: function (field) {
                this.chooseChildShow=false;
                if (!this.isFolder) {
                    Vue.set(this.model, 'child', []);
                    this.addChild(this.model.extend,field);
                }else{
                    this.addChild(this.model.extend,field);
                }
            },
            addChild: function (extend,field) {
                for(var i in this.parts[extend]){
                    if(parts[extend][i]['field']==field.field){
                        var tmp=clone(parts[extend][i])//拷贝原码
                        this.model.child.push(tmp);
                        this.open=true;
                        //显示为展开
                        this.model.child[this.model.child.length-1]['open']=true;

                        break;
                    }
                }


            },
            delChild:function(){
                for(var i in this.$parent.$children){
                    if(this===this.$parent.$children[i]){
                        this.$parent.model.child.splice(i,1)

                        //only处理
                        for(var i in parts[this.$parent.model.extend]){
                            if(this.subparts[this.$parent.model.extend][i]['group']===this.model.group){
                                this.$parent.subparts[this.$parent.model.extend][i]['only']=false
                            }
                        }
                    break;
                    }
                }


            },
            hideItem: function () {
                alert(1);
                this.hide = true;
            }
        }
    });

    // boot up the demo
    var vm = new Vue({
        el: '#app',
        data: {
            treeData: data,
            parts:parts,
            treeProject:'base',
            treeProjectLists:[],
            treeName:'start',
            treeNameLists:[]
        },
        created:function() {
            this.updateTree()

            //隐藏选项，这里同上冗余
        },
        ready:function(){

        },
        computed: {
            getStr: function () {
                var new_obj={};

               return json_formate(obj_parser(new_obj,this.treeData));
                // return json_formate(this.treeData);
               //return JSON.stringify(obj_parser(new_obj,this.treeData))
            }
        },
        methods: {
            //保存树
            saveTree: function () {
                //已储存有树
                if (localStorage['tree']) {
                    var tmp = JSON.parse(localStorage['tree']);

                    //没有此项目则新建项目
                    if (!tmp[this.treeProject]) {
                        tmp[this.treeProject] = {}
                    }

                    //检查重名
                    if (tmp[this.treeProject][this.treeName]) {
                        if (!confirm('Name already exists, you want to replace it?')) {
                            return None;
                        }
                    }

                    tmp[this.treeProject][this.treeName] = this.treeData;
                    localStorage['tree'] = JSON.stringify(tmp);

                    //从未存储树（可以取消了）
                } else {
                    var tmp = {};
                    tmp[this.treeProject] = {}
                    tmp[this.treeProject][this.treeName] = this.treeData;
                    localStorage['tree'] = JSON.stringify(tmp);
                }
                //更新树的视图
                this.updateTree()
            },
            //打开树
            openTree: function () {
                var tmp = JSON.parse(localStorage['tree']);
                this.treeData = tmp[this.treeProject][this.treeName];
            },
            //更新树的显示
            updateTree: function () {
                //读取已本地保存的tree
                if (localStorage['tree']) {
                    var tree = JSON.parse(localStorage['tree']);
                    for (var key in tree) {
                        this.treeProjectLists.push(key);
                    }
                    for (var key in tree[this.treeProject]) {
                        this.treeNameLists.push(key);
                    }
                    //本地没有保存则创建新tree
                } else {
                    var tmp = {};
                    tmp[this.treeProject] = {}
                    tmp[this.treeProject][this.treeName] = this.treeData;
                    localStorage['tree'] = JSON.stringify(tmp);
                }
            }
        }
    })


</script>


</body>
</html>