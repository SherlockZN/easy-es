<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>


        .bold {
            /*font-weight: bold;*/
        }

    </style>
    <script src="http://cdn.bootcss.com/vue/1.0.17/vue.js"></script>
    <script src="http://cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>

    <script src="data.js"></script>
    <script src="parts.js"></script>

    <link href="assert/materialize/css/materialize.min.css" rel="stylesheet">
    <link href="assert/main.css" rel="stylesheet">

    <script src="assert/materialize/js/materialize.min.js"></script>
    <script src="help.js"></script>
</head>
<body>
<!-- item template -->
<script type="text/x-template" id="item-template">
    <li>
        <div :class="{bold: isFolder}">
            <!--有子项,显示+--><span @click="toggleOpen" v-if="isFolder">{{open ? '-' : '+'}}</span>
            <!-- 无子项，补白--><span @click="toggleOpen" v-else>&nbsp;&nbsp;</span>

            <!--field--><input type="text" v-model="model.field" class="data-field" placeholder="field">

            <!--value--><span v-if="!model.child  && !model.extend">: <input type="text" v-model="model.value" class="data-value" placeholder="value"></span>

            <span @click="delChild" v-if="!model.undelete">X</span>
            <!--有括展项-->
            <div v-if="chooseChildShow" class="choose-child-clear" @click="hideChildShow"></div>
            <span v-if="model.extend" class="choose-child">
                <a  href='#' @click="showchooseChild" >+</a>


                <!-- 下拉扩展项 -->
                <ul v-show="chooseChildShow" class="choose-child-box">
                    <li v-for="item in subparts[model.extend]"
                        v-show="!item.only"
                        @click="extendChild(item)">
                        <a href="#!">{{item.field}}</a>
                    </li>

                </ul>
            </span>

        </div>
        <ul v-show="open" v-if="isFolder">
            <item
                    class="data-item"
                    v-for="model in model.child"
                    :model="model"
                    :parts="parts"
                    >
            </item>

            <!--<li @click="addChild" v-show="false">+</li>-->
        </ul>
    </li>
</script>

<! -- nav -->
<nav>
    <div class="nav-wrapper">
        <div class="col s12">
            <a href="#!" class="brand-logo">&nbsp;&nbsp;ES Query</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="#">Document</a></li>
                <li><a href="https://github.com/whybangbang/es_query_dsl_mindmanger">Github</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- app -->
<div class="row" id="app" >
    <div class="col s6">
        <ul>
            <item
                    class="item"
                    :model="treeData"
                    :parts="parts">
            </item>
        </ul>
    </div>
    <div class="col s6">
        <p>Write DSL/Elasticsearch quickly! 让ES查询语句不发指！</p>
        <textarea class="getstr">{{{getStr}}}</textarea>
    </div>
</div>

<!-- footer -->
<footer class="page-footer">
    <div class="container">
        <div class="row">
            <div class="col l6 s12">
                <h5 class="white-text">Footer Content</h5>
                <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
            </div>
            <div class="col l4 offset-l2 s12">
                <h5 class="white-text">Links</h5>
                <ul>
                    <li><a class="grey-text text-lighten-3" href="http://es.xiaoleilu.com/">Elasticsearch 权威指南</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            © 2016 Copyright Text
            <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
        </div>
    </div>
</footer>


<script>
    function clone(obj){
        var o, obj;
        if (obj.constructor == Object){
            o = new obj.constructor();
        }else{
            o = new obj.constructor(obj.valueOf());
        }
        for(var key in obj){
            if ( o[key] != obj[key] ){
                if ( typeof(obj[key]) == 'object' ){
                    o[key] = clone(obj[key]);
                }else{
                    o[key] = obj[key];
                }
            }
        }
        o.toString = obj.toString;
        o.valueOf = obj.valueOf;
        return o;
    }
    /*
     编写示例：
     field str 字键名
     value 值，根据用户填的可自动生成，也可提供默认值
     extend 可扩展，默认为false不可扩展，为ture为随意扩展，为filter时为term、range、exist、bool、and扩展
     open 展开，默认为false，为true时默认为展开的
     root 是否为根元素，根元素不可删除
     choose 是否自动显示菜单 true为显示，false默认值
     undelete 无法删除，默认为false可删除，为true可删除
     group 组，用数字表明，同1组的在一个层下只能出现1次
     and、or、bool按array处理

     概念辨析：
     extend：增加子项
     add：增同级项目
     open： 展开显示
     only: 此值为唯一
     */
    //filter 可组合部分

    // 整体框架

    Vue.config.debug = true
    // define the item component
    Vue.component('item', {
        template: '#item-template',
        props: ['model','parts'],
        data: function () {
            return {
                open: this.model.open ? this.model.open : false,
                chooseChildShow:!!this.model.choose,
                subparts:clone(parts)
            }
        },
        computed: {
            isFolder: function () {
                return this.model.child &&
                        this.model.child.length
            }
        },
        methods: {
            toggleOpen: function () {
                if (this.isFolder) {
                    this.open = !this.open;
                }
            },
            showchooseChild:function(){
              this.chooseChildShow=true;
            },
            hideChildShow:function(){
                this.chooseChildShow=false;
            },
            extendChild: function (field) {
                this.chooseChildShow=false;
                if (!this.isFolder) {
                    Vue.set(this.model, 'child', []);
                    this.addChild(this.model.extend,field);
                }else{
                    this.addChild(this.model.extend,field);
                }
            },
            addChild: function (extend,field) {
                for(var i in this.parts[extend]){
                    if(parts[extend][i]['field']==field.field){
                        var tmp=clone(parts[extend][i])//拷贝原码
                        this.model.child.push(tmp);
                        this.open=true;
                        //显示为展开
                        this.model.child[this.model.child.length-1]['open']=true;

                        //only处理
                        if(field.group){
                            if(this.model.field!='and'&&this.model.field!='or'&&this.model.field!='bool'){ //判断是否可以为并

                                for(var i in parts[extend]){
                                    if(parts[extend][i].group===field.group){
                                        Vue.set(this.subparts[extend][i],'only',true)


                                    }

                                }
                        }
                        }
                        break;
                    }
                }


            },
            delChild:function(){
                for(var i in this.$parent.$children){
                    if(this===this.$parent.$children[i]){
                        this.$parent.model.child.splice(i,1)

                        //only处理
                        for(var i in parts[this.$parent.model.extend]){
                            if(this.subparts[this.$parent.model.extend][i]['group']===this.model.group){
                                this.$parent.subparts[this.$parent.model.extend][i]['only']=false
                            }
                        }
                    break;
                    }
                }


            },
            hideItem: function () {
                alert(1);
                this.hide = true;
            }
        }
    });

    // boot up the demo
    var vm = new Vue({
        el: '#app',
        data: {
            treeData: data,
            parts:parts
        },
        computed: {
            getStr: function () {
                var new_obj={};

               return json_formate(this.obj_parser(new_obj,this.treeData));
               //return json_formate(this.treeData);
            }
        },
        methods: {
            //转译json
            obj_parser: function (new_obj, obj){
                if(obj.hasOwnProperty('child')){

                    var tmp={};
                    //and、or、bool转数组
                    if(obj['field']=='and' || obj['field']=='or' || obj['field']=='bool'){
                        new_obj[obj['field']]=[]
                        for(var key in obj['child']){
                            var t=clone(this.obj_parser(tmp, obj['child'][key]))
                            new_obj[obj['field']].push(t);
                        }
                    //不转数组
                    }else{
                        for(var key in obj['child']){
                            new_obj[obj['field']] = this.obj_parser(tmp, obj['child'][key]);
                        }

                    }
                }else{

                    new_obj[obj['field']] = obj['value'];
                    return new_obj

                }
                return new_obj
            }


        },
        cc:function(){
            return 4;
        }
    })

</script>


</body>
</html>