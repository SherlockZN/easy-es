<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>


        .bold {
            /*font-weight: bold;*/
        }

    </style>
    <script src="http://cdn.bootcss.com/vue/1.0.17/vue.js"></script>
    <script src="http://cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <script src="assert/clipboard.min.js"></script>

    <script src="data.js"></script>
    <script src="parts.js"></script>

    <link href="assert/materialize/css/materialize.min.css" rel="stylesheet">
    <link href="assert/main.css" rel="stylesheet">

    <script src="assert/materialize/js/materialize.min.js"></script>
    <script src="help.js"></script>
</head>
<body id="app" @click="hideChildShow">
<!-- item template -->
<script type="text/x-template" id="item-template">
    <li>
        <div :class="{bold: isFolder}">
            <!--有子项,显示+--><span @click="toggleOpen" v-if="isFolder">{{open ? '-' : '+'}}</span>
            <!-- 无子项，补白--><span @click="toggleOpen" v-else>&nbsp;&nbsp;</span>

            <!--field--><input type="text" v-model="model.field" class="data-field" placeholder="field">

            <!--value--><span v-if="!model.child  && !model.extend">:
                <input  v-if="!model.arrayValue"
                        type="text" v-model="model.value" class="data-value" placeholder="{{model.placeholder || 'value'}}">

                <select v-else v-model="model.value" class="tree_select">
                    <option v-for="v in model.arrayValue ">{{v}}</option>
                </select>

            </span>

            <!--启用自定义模式--><span v-if="parts.tree_customize">
            <a @click="extendCustomizeChild" class="customize-add">add</a>
            <span class="customize-array">
                <input type="checkbox" id="customize-array" v-model="model.array">
                <label for="customize-array">array</label>
            </span>
            </span>


            <span @click="delChild" v-if="!model.undelete">X</span>
            <!--有括展项-->
            <span v-if="model.extend" class="choose-child">
                <a  href='#' @click.stop="showchooseChild" v-bind:class="{'color-grey':view.hideChooseChildBtn}">+</a>

                <!-- 下拉扩展项 -->
                <ul v-show="chooseChildShow" class="choose-child-box">
                    <li v-for="item in subparts"
                        v-show="!item.only"
                        v-if="!item.disabled"
                        @click.stop="extendChild($key)">
                        <a href="#!">{{$key}}</a>
                    </li>

                </ul>
            </span>

        </div>
        <ul v-show="open" v-if="isFolder">
            <item
                    class="data-item"
                    v-for="model in model.child"
                    :model="model"
                    :parts="parts"
                    >
            </item>

        </ul>
    </li>
</script>

<! -- nav -->
<nav>
    <div class="nav-wrapper">
        <div class="col s12">
            <a href="#!" class="brand-logo">&nbsp;&nbsp;ES Query</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="#">Document</a></li>
                <li><a href="https://github.com/whybangbang/es_query_dsl_mindmanger">Github</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- app -->
<div >

    <div class="row">
        <div class="col s2 input-select">
            <input type="text" v-model="treeProject">
            <select v-model="treeProject">
                <option v-for="item in treeProjectLists" track-by="$index">{{item}}</option>
            </select>

        </div>
        <div class="col s6 input-select">
            <input type="text" v-model="treeName">
            <select v-model="treeName">
                <option v-for="item in treeNameLists" track-by="$index">{{item}}</option>
            </select>
        </div>
        <div class="col s4">
            <a  @click="openTree" class="waves-effect waves-light btn">open</a>
            <a @click="saveTree"  class="waves-effect waves-light btn">save</a>
        </div>
    </div>
    <div class="row">
        <div class="switch">
            <label>
                <input type="checkbox" v-model="parts.tree_customize">
                <span class="lever"></span>
                Customize Model
            </label>
        </div>

    </div>
    <!--<a  @mouseover="ss">Hover me!</a>-->
    <div class="row">
        <div class="col s6">
            <ul>
                <item
                        class="item"
                        :model="treeData"
                        :parts="parts">
                </item>
            </ul>
        </div>
        <div class="col s6">
            <a class=" btn waves-effect waves-teal btn-flat" data-clipboard-target="#getstr">cope code</a>
            <textarea class="getstr" id="getstr">{{{getStr | json 4}}}</textarea>
            <textarea >{{getTree}}</textarea>
        </div>
    </div>
</div>

<!-- footer -->
<footer class="page-footer">
    <div class="container">
        <div class="row">
            <div class="col l6 s12">
                <h5 class="white-text">Footer Content</h5>
                <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
            </div>
            <div class="col l4 offset-l2 s12">
                <h5 class="white-text">Links</h5>
                <ul>
                    <li><a class="grey-text text-lighten-3" href="http://es.xiaoleilu.com/">Elasticsearch 权威指南</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                    <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            © 2016 Copyright Text
            <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
        </div>
    </div>
</footer>


<script>
    //注册剪贴板
    new Clipboard('.btn');
    // 整体框架
    Vue.config.debug = true
    // define the item component
    Vue.component('item', {
        template: '#item-template',
        props: ['model','parts'],
        data: function () {
            return {
                array:this.model.array ? this.model.array : false,
                open: this.model.open ? this.model.open : false,
                chooseChildShow:this.model.choose ? this.model.choose : false,
                subparts:help.clone(parts[this.model.extend]),
                view:{}
            }
        },
        created:function(){
            //清除父展开的选项
            if(this.$parent.hasOwnProperty('chooseChildShow')){
                this.$parent.chooseChildShow=false;
            }
        },
        computed: {
            isFolder: function () {
                return this.model.child &&
                        this.model.child.length
            },
            isArray:function(){
                return (typeof this.model.value=='object')&&this.model.value.constructor==Array;
            }
        },
        methods: {
            toggleOpen: function () {
                if (this.isFolder) {
                    this.open = !this.open;
                }
            },
            //显示可添加的子项
            showchooseChild:function(){

                //only 处理
                if(!this.model.array){//排除and、or
                    //遍历子对象
                    for(var son in this.$children){
                        if(this.$children[son].model.group){//判断是否分组
                            var group_number=this.$children[son].model.group;//得到分组号

                            //修改数据subparts
                            for(var part in this.subparts){
                                if(this.subparts[part].group===group_number){
                                    Vue.set(this.subparts[part],'only',true)
                                }
                            }
                        }
                    }
                }
              this.chooseChildShow=true;
            },

            //扩展子项目
            //field str 子项目的名称
             extendChild: function (field) {
                 //影藏所有展开的弹出菜单
                 function hide(obj){
                     obj.$data.chooseChildShow=false;
                     //隐藏所有的子选项
                     for(var i in obj.$children){
                         hide(obj.$children[i])
                     }
                 }
                 hide(this);

                // 检查有无子child 数组
                if (!this.isFolder) {
                    Vue.set(this.model, 'child', []);
                }

                //添加子项目,用push方法
                //this.addChild(this.model.extend,field);
                var child=help.clone(this.subparts[field]);

                 //增加 field 名称
                 if(!child.hasOwnProperty('field')){
                     child.field=field;
                 }

                this.model.child.push(child);

                //展开新添加的内容
                this.open=true
                this.model.child[this.model.child.length-1]['open']=true;

                 //检查还有无可增加的子选项
                 var check_child=true
                 for(part in this.subparts){
                     if(!this.subparts[part].only){
                         check_child=false
                     }
                 }
                if(check_child){
                    Vue.set(this.view,'hideChooseChildBtn',true)
                }

            },
            //扩展自定义项目
            extendCustomizeChild:function(){
                if(!this.isFolder){
                    Vue.set(this.model, 'child', []);
                }
                this.model.child.push({
                    'field':'',
                    'open':true
                })

            },
            //删除自项目
            delChild:function(){
                for(var i in this.$parent.$children){
                    if(this===this.$parent.$children[i]){
                        //通过父删除自己
                        this.$parent.model.child.splice(i,1)

                        //唯一属性的恢复 only处理
                        for(var part in this.$parent.subparts){
                            if(this.$parent.subparts[part]['group']===this.model.group){
                                this.$parent.subparts[part]['only']=false
                            }
                        }
                        break;
                    }
                }

                //检查父有无可增加的项
                for(part in this.$parent.subparts){
                    if(!this.$parent.subparts[part].only){
                        this.$parent.view.hideChooseChildBtn=false
                    }
                }
            }

        }
    });

    // boot up the demo
    var vm = new Vue({
        el: '#app',
        data: {
            treeData: data,
            parts:parts,
            treeProject:'base',
            treeProjectLists:[],
            treeName:'start',
            treeNameLists:[]
        },
        created:function() {
            this.updateTree();
            this.parts.tree_chooseChidShow=true;

            //隐藏选项，这里同上冗余
        },
        watch: {
            treeProject:'updateTree'
        },
        computed: {
            getStr: function () {
                var new_obj={};

                return help.obj_parser(new_obj,this.treeData)[this.treeData.field];

            },
            getTree: function(){
                return JSON.stringify(this.treeData);
            }
        },
        methods: {
            //保存树
            saveTree: function () {
                //已储存有树
                if (localStorage['tree']) {
                    var tmp = JSON.parse(localStorage['tree']);

                    //没有此项目则新建项目
                    if (!tmp[this.treeProject]) {
                        tmp[this.treeProject] = {}
                    }

                    //检查重名
                    if (tmp[this.treeProject][this.treeName]) {
                        if (!confirm('Name already exists, you want to replace it?')) {
                            return ;
                        }
                    }

                    tmp[this.treeProject][this.treeName] = this.treeData;
                    localStorage['tree'] = JSON.stringify(tmp);

                    //从未存储树（可以取消了）
                } else {
                    var tmp = {};
                    tmp[this.treeProject] = {}
                    tmp[this.treeProject][this.treeName] = this.treeData;
                    localStorage['tree'] = JSON.stringify(tmp);
                }
                //更新树的视图
                this.updateTree()
                Materialize.toast('template saved', 4000)
            },
            //打开树
            openTree: function () {
                var tmp = JSON.parse(localStorage['tree']);
                if(tmp[this.treeProject][this.treeName]){
                    this.treeData = tmp[this.treeProject][this.treeName];
                    Materialize.toast('template open', 4000)
                }else{
                    Materialize.toast("there is no this template,pleses check name", 4000)
                }

            },
            //更新树的显示
            updateTree: function () {

                //读取已本地保存的tree
                if (localStorage['tree']) {
                    var tree = JSON.parse(localStorage['tree']);
                    this.treeProjectLists=[]; //清空之前的选项
                    for (var key in tree) {
                        this.treeProjectLists.push(key);
                    }
                    this.treeNameLists=[];//清空之前的选项
                    for (var key in tree[this.treeProject]) {
                        this.treeNameLists.push(key);
                    }
                    //本地没有保存则创建新tree
                } else {
                    var tmp = {};
                    tmp[this.treeProject] = {}
                    tmp[this.treeProject][this.treeName] = this.treeData;
                    localStorage['tree'] = JSON.stringify(tmp);
                }
            },
            ss:function(){
                alert(1)
            },
            //隐藏添加子选项菜单
            hideChildShow:function(){
                function hide(obj){
                    obj.$data.chooseChildShow=false;
                    //隐藏所有的子选项
                    for(var i in obj.$children){
                        hide(obj.$children[i])
                    }
                }
                hide(this);


            }
        }
    })


</script>


</body>
</html>